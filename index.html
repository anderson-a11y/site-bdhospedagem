<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BD Hotelaria</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        costana: { DEFAULT: '#475C2A', light: '#637D3D', dark: '#2E3D1B', bg: '#F2F5ED' }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f5f5f4; color: #44403c; }
        .chart-container { position: relative; width: 100%; height: 300px; }
        .tab-active { border-bottom: 2px solid #475C2A; color: #475C2A; font-weight: 600; }
        .tab-inactive { border-bottom: 2px solid transparent; color: #78716c; }
        .tab-inactive:hover { color: #475C2A; }
        th.sortable { cursor: pointer; user-select: none; transition: background-color 0.2s; }
        th.sortable:hover { background-color: #e7e5e4; }
        th.sortable span.icon { margin-left: 4px; font-size: 0.7em; opacity: 0.5; }
        th.sortable.asc span.icon::after { content: '‚ñ≤'; }
        th.sortable.desc span.icon::after { content: '‚ñº'; }
        th.sortable span.icon::after { content: '‚Üï'; }
        .custom-scrollbar::-webkit-scrollbar { height: 8px; width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f5f5f4; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d6d3d1; border-radius: 4px; }
        input[type="file"]::file-selector-button { margin-right: 10px; border: none; background: #475C2A; padding: 6px 10px; border-radius: 4px; color: white; cursor: pointer; }
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow-x: hidden; overflow-y: visible !important; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50 border-b border-stone-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-20 items-center">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-costana rounded-lg flex items-center justify-center text-white font-serif font-bold text-2xl shadow-sm">C</div>
                    <div class="flex flex-col">
                        <span class="font-bold text-xl tracking-tight text-costana leading-none">Banco de Dados</span>
                        <span class="font-medium text-xs tracking-widest text-stone-500 uppercase">Hotelaria</span>
                    </div>
                </div>
                <nav class="flex space-x-8">
                    <button onclick="switchTab('overview')" id="nav-overview" class="tab-active px-1 pt-1 text-sm font-medium transition-colors">Vis√£o Geral</button>
                    <button onclick="switchTab('dashboard')" id="nav-dashboard" class="tab-inactive px-1 pt-1 text-sm font-medium transition-colors">Dashboard</button>
                    <button onclick="switchTab('database')" id="nav-database" class="tab-inactive px-1 pt-1 text-sm font-medium transition-colors">Gest√£o de Dados</button>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">

        <!-- OVERVIEW -->
        <section id="view-overview" class="space-y-8 animate-fade-in">
            <!-- Welcome Card -->
            <div class="bg-white rounded-xl shadow-sm border border-stone-200 p-6 md:p-8 relative overflow-hidden mb-8">
                <div class="absolute top-0 right-0 w-32 h-32 bg-costana opacity-5 rounded-bl-full -mr-10 -mt-10"></div>
                <h1 class="text-3xl font-bold text-stone-800 mb-4">Sistema de Intelig√™ncia</h1>
                <p class="text-stone-600 leading-relaxed text-lg max-w-4xl">
                    Painel administrativo para gest√£o e an√°lise da concorr√™ncia nas 77 cidades de atua√ß√£o.
                </p>
                <div class="mt-4 flex gap-4">
                    <div class="p-4 bg-green-50 rounded-lg border border-green-100 w-full md:w-1/2">
                        <h4 class="font-bold text-costana mb-1">Status do Sistema</h4>
                        <p class="text-sm text-stone-600" id="db-status-text">Inicializando...</p>
                    </div>
                </div>
            </div>

            <!-- Tutorial Section -->
            <div class="bg-white rounded-xl shadow-sm border border-stone-200 p-6">
                <h3 class="text-xl font-bold text-stone-800 mb-6 flex items-center gap-2">
                    <span class="bg-costana text-white w-8 h-8 rounded-full flex items-center justify-center text-sm">?</span>
                    Fluxo de Atualiza√ß√£o (Vercel/GitHub)
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <!-- Step 1 -->
                    <div class="relative pl-4 border-l-2 border-stone-200">
                        <div class="mb-2 text-costana font-bold text-sm uppercase tracking-wide">Passo 01</div>
                        <h4 class="font-semibold text-stone-800 mb-1">Visualizar</h4>
                        <p class="text-sm text-stone-500">O sistema carrega automaticamente o arquivo <code>banco_dados.csv</code> do reposit√≥rio.</p>
                    </div>
                    
                    <!-- Step 2 -->
                    <div class="relative pl-4 border-l-2 border-stone-200">
                        <div class="mb-2 text-costana font-bold text-sm uppercase tracking-wide">Passo 02</div>
                        <h4 class="font-semibold text-stone-800 mb-1">Editar Localmente</h4>
                        <p class="text-sm text-stone-500">Fa√ßa altera√ß√µes (Novo/Editar/Excluir) na aba <strong>Gest√£o</strong>. Isso salva apenas no seu navegador.</p>
                    </div>

                    <!-- Step 3 -->
                    <div class="relative pl-4 border-l-2 border-stone-200">
                        <div class="mb-2 text-costana font-bold text-sm uppercase tracking-wide">Passo 03</div>
                        <h4 class="font-semibold text-stone-800 mb-1">Baixar Atualiza√ß√£o</h4>
                        <p class="text-sm text-stone-500">Clique em <strong>Op√ß√µes > Baixar CSV</strong> para gerar o arquivo atualizado.</p>
                    </div>

                    <!-- Step 4 -->
                    <div class="relative pl-4 border-l-2 border-stone-200">
                        <div class="mb-2 text-costana font-bold text-sm uppercase tracking-wide">Passo 04</div>
                        <h4 class="font-semibold text-stone-800 mb-1">Atualizar Reposit√≥rio</h4>
                        <p class="text-sm text-stone-500">Substitua o arquivo <code>banco_dados.csv</code> no GitHub pelo novo que voc√™ baixou. O site atualizar√° em minutos.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- DASHBOARD -->
        <section id="view-dashboard" class="hidden space-y-8 animate-fade-in">
            <div class="bg-white rounded-xl shadow-sm border border-stone-200 p-6">
                <h2 class="text-2xl font-bold text-stone-800 mb-2">Dashboard Geral</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <div class="p-4 bg-costana-bg rounded-lg border border-stone-100">
                        <div class="text-xs font-semibold text-stone-500 uppercase">Total Cadastrado</div>
                        <div class="text-3xl font-bold text-costana-dark" id="stat-total">0</div>
                    </div>
                    <div class="p-4 bg-costana-bg rounded-lg border border-stone-100">
                        <div class="text-xs font-semibold text-stone-500 uppercase">Pre√ßo M√©dio</div>
                        <div class="text-3xl font-bold text-costana-dark" id="stat-price">R$ 0</div>
                    </div>
                    <div class="p-4 bg-costana-bg rounded-lg border border-stone-100">
                        <div class="text-xs font-semibold text-stone-500 uppercase">Nota M√©dia</div>
                        <div class="text-3xl font-bold text-costana" id="stat-rating">0.0</div>
                    </div>
                    <div class="p-4 bg-costana-bg rounded-lg border border-stone-100">
                        <div class="text-xs font-semibold text-stone-500 uppercase">Cidades</div>
                        <div class="text-3xl font-bold text-costana-dark" id="stat-cities">0</div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="bg-white p-4 rounded-lg border border-stone-100 shadow-sm">
                        <h3 class="text-sm font-semibold mb-4 text-center text-stone-700 uppercase tracking-wide">Distribui√ß√£o por Tipo</h3>
                        <div class="chart-container"><canvas id="typeChart"></canvas></div>
                    </div>
                    <div class="bg-white p-4 rounded-lg border border-stone-100 shadow-sm">
                        <h3 class="text-sm font-semibold mb-4 text-center text-stone-700 uppercase tracking-wide">Volume por Regi√£o</h3>
                        <div class="chart-container"><canvas id="regionCountChart"></canvas></div>
                    </div>
                    <div class="bg-white p-4 rounded-lg border border-stone-100 shadow-sm">
                        <h3 class="text-sm font-semibold mb-4 text-center text-stone-700 uppercase tracking-wide">Qualidade por Regi√£o</h3>
                        <div class="chart-container"><canvas id="regionChart"></canvas></div>
                    </div>
                    <div class="bg-white p-4 rounded-lg border border-stone-100 shadow-sm">
                        <h3 class="text-sm font-semibold mb-4 text-center text-stone-700 uppercase tracking-wide">Faixa de Pre√ßo</h3>
                        <div class="chart-container"><canvas id="priceChart"></canvas></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- DATABASE -->
        <section id="view-database" class="hidden space-y-6 animate-fade-in">
            <div class="bg-white rounded-xl shadow-sm border border-stone-200 p-6">
                <!-- Toolbar -->
                <div class="flex flex-col xl:flex-row justify-between items-end gap-4 mb-6 bg-stone-50 p-4 rounded-lg border border-stone-100">
                    <div class="flex-grow w-full grid grid-cols-1 md:grid-cols-3 gap-2">
                        <div><label class="text-xs font-bold text-stone-500 ml-1">Buscar</label><input type="text" id="filter-text" placeholder="Nome, Endere√ßo, Cidade..." class="w-full border p-2 rounded text-sm focus:ring-2 focus:ring-costana outline-none"></div>
                        <div><label class="text-xs font-bold text-stone-500 ml-1">Regi√£o</label><select id="filter-region" class="w-full border p-2 rounded text-sm bg-white outline-none"><option value="all">Todas</option></select></div>
                        <div><label class="text-xs font-bold text-stone-500 ml-1">Tipo</label><select id="filter-type" class="w-full border p-2 rounded text-sm bg-white outline-none"><option value="all">Todos</option></select></div>
                    </div>
                    <div class="flex gap-2 flex-wrap justify-end w-full xl:w-auto">
                        <button onclick="openModal()" class="flex items-center gap-2 px-4 py-2 bg-costana text-white rounded hover:bg-costana-dark text-sm font-medium transition-colors shadow-sm">Novo</button>
                        <div class="relative group">
                            <button class="flex items-center gap-2 px-4 py-2 bg-white border border-stone-300 text-stone-600 rounded hover:bg-stone-50 text-sm font-medium transition-colors shadow-sm">Op√ß√µes de Arquivo</button>
                            <div class="absolute right-0 mt-2 w-56 bg-white rounded-md shadow-xl z-20 hidden group-hover:block border border-stone-100">
                                <a href="#" onclick="forceReloadFromServer()" class="block px-4 py-3 text-sm text-costana font-semibold hover:bg-stone-50 border-b">‚Üª Recarregar do Servidor</a>
                                <div class="p-3 border-b border-stone-100"><p class="text-xs font-bold text-stone-400 mb-2">IMPORTAR LOCALMENTE</p><input type="file" id="csvInput" accept=".csv" class="w-full text-xs text-stone-500"/></div>
                                <a href="#" onclick="downloadCSV()" class="block px-4 py-3 text-sm text-stone-700 hover:bg-stone-50">Baixar CSV Backup</a>
                                <a href="#" onclick="hardReset()" class="block px-4 py-3 text-sm text-red-600 hover:bg-red-50">Limpar Tudo</a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto custom-scrollbar border rounded-lg max-h-[600px]">
                    <table class="min-w-full divide-y divide-stone-200 relative text-sm">
                        <thead class="bg-stone-50 sticky top-0 z-10 shadow-sm">
                            <tr>
                                <th onclick="handleSort('id')" class="sortable px-4 py-3 text-left text-xs font-medium text-stone-500 uppercase w-12">ID <span class="icon"></span></th>
                                <th onclick="handleSort('name')" class="sortable px-4 py-3 text-left text-xs font-medium text-stone-500 uppercase">Nome <span class="icon"></span></th>
                                <th onclick="handleSort('city')" class="sortable px-4 py-3 text-left text-xs font-medium text-stone-500 uppercase">Cidade <span class="icon"></span></th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-stone-500 uppercase w-64">Localiza√ß√£o (Link Maps)</th>
                                <th onclick="handleSort('type')" class="sortable px-4 py-3 text-left text-xs font-medium text-stone-500 uppercase">Tipo <span class="icon"></span></th>
                                <th onclick="handleSort('price')" class="sortable px-4 py-3 text-left text-xs font-medium text-stone-500 uppercase">Pre√ßo <span class="icon"></span></th>
                                <th onclick="handleSort('rating')" class="sortable px-4 py-3 text-left text-xs font-medium text-stone-500 uppercase">Nota <span class="icon"></span></th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-stone-500 uppercase">Contato</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-stone-500 uppercase">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-stone-200" id="table-body"></tbody>
                    </table>
                </div>
                <div class="mt-4 flex justify-between items-center text-sm text-stone-500"><span id="showing-count">...</span></div>
            </div>
        </section>
    </main>

    <!-- MODAL -->
    <div id="modal-add" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-black opacity-50 backdrop-blur-sm" onclick="closeModal()"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-lg mx-auto rounded-xl shadow-2xl z-50 overflow-y-auto max-h-[90vh]">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3 border-b border-stone-100">
                    <p class="text-xl font-bold text-costana" id="modal-title">Novo Cadastro</p>
                    <div class="modal-close cursor-pointer z-50 p-2 hover:bg-stone-100 rounded-full" onclick="closeModal()">
                        <svg class="stroke-current text-stone-500" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </div>
                </div>
                <div class="my-5 space-y-4">
                    <input type="hidden" id="edit-index">
                    <div class="grid grid-cols-3 gap-3">
                        <div class="col-span-1"><label class="text-xs font-bold text-stone-500 uppercase">ID</label><input type="number" id="new-id" class="w-full border border-stone-300 bg-stone-100 p-2 rounded text-sm font-mono text-stone-500" readonly></div>
                        <div class="col-span-2"><label class="text-xs font-bold text-stone-500 uppercase">Nome</label><input id="new-name" class="w-full border border-stone-300 p-2 rounded text-sm focus:ring-2 focus:ring-costana outline-none"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-xs font-bold text-stone-500 uppercase">Cidade</label><input id="new-city" class="w-full border border-stone-300 p-2 rounded text-sm focus:ring-2 focus:ring-costana outline-none"></div>
                        <div><label class="text-xs font-bold text-stone-500 uppercase">Regi√£o</label><select id="new-region" class="w-full border border-stone-300 p-2 rounded text-sm bg-white outline-none"><option>Fronteira Noroeste</option><option>Celeiro</option><option>Miss√µes</option><option>Noroeste Colonial</option></select></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-xs font-bold text-stone-500 uppercase">Tipo</label><select id="new-type" class="w-full border border-stone-300 p-2 rounded text-sm bg-white outline-none"><option>Hotel</option><option>Pousada</option><option>Cabana</option><option>Resort</option></select></div>
                        <div><label class="text-xs font-bold text-stone-500 uppercase">Pre√ßo</label><input type="number" id="new-price" class="w-full border border-stone-300 p-2 rounded text-sm focus:ring-2 focus:ring-costana outline-none" placeholder="0.00"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-xs font-bold text-stone-500 uppercase">Nota</label><input type="number" step="0.1" max="5" id="new-rating" class="w-full border border-stone-300 p-2 rounded text-sm focus:ring-2 focus:ring-costana outline-none"></div>
                        <div><label class="text-xs font-bold text-stone-500 uppercase">Telefone</label><input id="new-phone" class="w-full border border-stone-300 p-2 rounded text-sm focus:ring-2 focus:ring-costana outline-none"></div>
                    </div>
                    <div><label class="text-xs font-bold text-stone-500 uppercase">Endere√ßo (Texto)</label><input id="new-address" class="w-full border border-stone-300 p-2 rounded text-sm focus:ring-2 focus:ring-costana outline-none" placeholder="Rua, N√∫mero..."></div>
                    <div><label class="text-xs font-bold text-stone-500 uppercase">Link Google Maps (Obrigat√≥rio para Localiza√ß√£o)</label><input id="new-link" class="w-full border border-stone-300 p-2 rounded text-sm focus:ring-2 focus:ring-costana outline-none" placeholder="https://maps.google.com/..."></div>
                </div>
                <div class="flex justify-end pt-4 border-t border-stone-100 gap-2">
                    <button onclick="closeModal()" class="px-4 py-2 bg-white border border-stone-300 rounded text-stone-600 hover:bg-stone-50 text-sm font-medium">Cancelar</button>
                    <button onclick="saveEntry()" class="px-6 py-2 bg-costana text-white rounded hover:bg-costana-dark font-medium text-sm shadow-md transition-transform active:scale-95">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN SCRIPT -->
    <script>
        let appData = [], sortCol = 'id', sortDir = 'asc', charts = {};

        document.addEventListener('DOMContentLoaded', () => { initApp(); setupListeners(); switchTab('overview'); });

        async function initApp() {
            // 1. Try LocalStorage
            const saved = localStorage.getItem('costanaData');
            if (saved) {
                try {
                    appData = JSON.parse(saved);
                    document.getElementById('db-status-text').textContent = `Dados recuperados da mem√≥ria local (${appData.length} registros).`;
                    document.getElementById('db-status-text').className = "text-sm text-amber-600 font-bold";
                    refreshAll();
                    return;
                } catch(e) {}
            }

            // 2. If no local data, try fetching 'banco_dados.csv' from root
            await forceReloadFromServer();
        }

        async function forceReloadFromServer() {
            document.getElementById('db-status-text').textContent = "Buscando 'banco_dados.csv' no servidor...";
            try {
                const response = await fetch('./banco_dados.csv');
                if (response.ok) {
                    const text = await response.text();
                    const parsed = parseCSVLogic(text);
                    if (parsed.length > 0) {
                        appData = parsed;
                        // Don't autosave to storage yet, let user be 'clean' state until edit
                        // localStorage.removeItem('costanaData'); 
                        document.getElementById('db-status-text').textContent = `Dados carregados do servidor (${appData.length} registros).`;
                        document.getElementById('db-status-text').className = "text-sm text-green-600 font-bold";
                        refreshAll();
                    } else {
                        throw new Error("Arquivo vazio");
                    }
                } else {
                    document.getElementById('db-status-text').textContent = "Arquivo 'banco_dados.csv' n√£o encontrado no reposit√≥rio.";
                    document.getElementById('db-status-text').className = "text-sm text-red-600 font-bold";
                }
            } catch (err) {
                console.warn(err);
                document.getElementById('db-status-text').textContent = "Modo Offline / Sem arquivo base.";
            }
        }

        function saveToStorage() { 
            localStorage.setItem('costanaData', JSON.stringify(appData)); 
            document.getElementById('db-status-text').textContent = "Altera√ß√µes salvas localmente (n√£o publicadas).";
            document.getElementById('db-status-text').className = "text-sm text-amber-600 font-bold";
            refreshAll(); 
        }
        
        function hardReset() { 
            if(confirm("Isso limpar√° os dados do navegador. Se houver um arquivo no servidor, ele ser√° recarregado.")) { 
                localStorage.removeItem('costanaData'); 
                appData = []; 
                initApp(); // Try reloading from server
            } 
        }
        
        function refreshAll() { updateFilterDropdowns(); filterAndRender(); renderCharts(); updateStats(); }

        // --- CRUD ---
        function openModal(id = null) {
            const modal = document.getElementById('modal-add');
            document.getElementById('edit-index').value = id ? appData.findIndex(d => d.id == id) : "-1";
            document.getElementById('modal-title').textContent = id ? "Editar" : "Novo";
            modal.classList.remove('opacity-0', 'pointer-events-none');
            document.body.classList.add('modal-active');
            
            const d = id ? appData.find(x => x.id == id) : {};
            if(!id) {
                let max = 0; appData.forEach(i=>{ let n=parseInt(String(i.id).replace(/\D/g,'')); if(n>max) max=n; });
                d.id = max + 1; 
                ['new-name','new-city','new-price','new-rating','new-phone','new-link','new-address'].forEach(k=>document.getElementById(k).value='');
            } else {
                ['name','city','region','type','price','rating','phone','link','address'].forEach(k => document.getElementById('new-'+k).value = d[k]||'');
            }
            document.getElementById('new-id').value = d.id;
        }
        function closeModal() { document.getElementById('modal-add').classList.add('opacity-0', 'pointer-events-none'); document.body.classList.remove('modal-active'); }
        
        function saveEntry() {
            const idx = parseInt(document.getElementById('edit-index').value);
            const entry = {
                id: document.getElementById('new-id').value,
                name: document.getElementById('new-name').value,
                city: document.getElementById('new-city').value,
                region: document.getElementById('new-region').value,
                type: document.getElementById('new-type').value,
                price: parseFloat(document.getElementById('new-price').value)||0,
                rating: parseFloat(document.getElementById('new-rating').value)||0,
                phone: document.getElementById('new-phone').value,
                address: document.getElementById('new-address').value,
                link: document.getElementById('new-link').value,
                info: "Atualizado"
            };
            if(idx>=0) appData[idx] = entry; else appData.push(entry);
            saveToStorage(); closeModal();
        }
        function deleteEntry(id) { if(confirm("Excluir?")) { appData = appData.filter(d=>d.id!=id); saveToStorage(); } }

        // --- FILTER & RENDER ---
        function filterAndRender() {
            const r = document.getElementById('filter-region').value;
            const t = document.getElementById('filter-type').value;
            const s = document.getElementById('filter-text').value.toLowerCase();
            let res = appData.filter(d => (r==='all'||d.region===r) && (t==='all'||d.type===t) && (!s||String(d.name).toLowerCase().includes(s)||String(d.city).toLowerCase().includes(s)||String(d.address).toLowerCase().includes(s)));
            
            res.sort((a,b) => {
                let vA = a[sortCol], vB = b[sortCol];
                if(sortCol==='id') return sortDir==='asc' ? String(vA).localeCompare(String(vB),undefined,{numeric:true}) : String(vB).localeCompare(String(vA),undefined,{numeric:true});
                vA=String(vA).toLowerCase(); vB=String(vB).toLowerCase();
                return sortDir==='asc' ? (vA<vB?-1:1) : (vA>vB?-1:1);
            });

            document.querySelectorAll('th.sortable').forEach(th=>th.classList.remove('asc','desc'));
            const th = document.querySelector(`th[onclick="handleSort('${sortCol}')"]`); if(th) th.classList.add(sortDir);

            document.getElementById('table-body').innerHTML = res.map(d => `
                <tr class="hover:bg-stone-50 border-b border-stone-100 transition-colors group">
                    <td class="px-4 py-3 text-xs text-stone-400 font-mono">${d.id}</td>
                    <td class="px-4 py-3 text-sm font-medium text-stone-900">${d.name}</td>
                    <td class="px-4 py-3 text-sm text-stone-600">${d.city}<br><span class="text-[10px] text-stone-400 uppercase">${d.region}</span></td>
                    
                    <!-- ADDRESS COLUMN WITH LINK INTEGRATION -->
                    <td class="px-4 py-3 text-xs text-stone-500 max-w-[200px] truncate" title="${d.address||''}">
                        ${d.link && d.link.length > 5 
                            ? `<a href="${d.link}" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline flex items-center gap-1">
                                 ${d.address && d.address.length > 2 ? d.address : 'Ver Localiza√ß√£o üìç'}
                                 <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-50"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
                               </a>` 
                            : (d.address || '-')}
                    </td>

                    <td class="px-4 py-3"><span class="px-2 py-1 text-xs font-semibold rounded bg-costana-bg text-costana-dark border border-stone-200">${d.type}</span></td>
                    <td class="px-4 py-3 text-sm font-mono text-stone-700">${d.price>0?'R$ '+d.price.toLocaleString('pt-BR',{minimumFractionDigits:2}):'-'}</td>
                    <td class="px-4 py-3 text-sm font-bold ${d.rating>=4.5?'text-costana':(d.rating<3.8?'text-red-500':'text-stone-600')}">${d.rating>0?d.rating.toLocaleString('pt-BR'):'-'}</td>
                    <td class="px-4 py-3 text-xs text-stone-500 font-mono">${d.phone||'-'}</td>
                    <td class="px-4 py-3 text-right whitespace-nowrap">
                        <button onclick="openModal('${d.id}')" class="p-1.5 bg-stone-100 text-stone-600 rounded hover:bg-stone-200 mr-1" title="Editar">‚úé</button>
                        <button onclick="deleteEntry('${d.id}')" class="p-1.5 bg-red-50 text-red-600 rounded hover:bg-red-100" title="Excluir">üóë</button>
                    </td>
                </tr>
            `).join('');
            document.getElementById('showing-count').textContent = `Mostrando ${res.length} registros`;
        }

        function handleSort(c) { if(sortCol===c) sortDir=sortDir==='asc'?'desc':'asc'; else {sortCol=c; sortDir='asc';} filterAndRender(); }
        
        function updateFilterDropdowns() {
            const reg = [...new Set(appData.map(d=>d.region).filter(Boolean))].sort();
            const typ = [...new Set(appData.map(d=>d.type).filter(Boolean))].sort();
            const selR = document.getElementById('filter-region'), selT = document.getElementById('filter-type');
            const vR = selR.value, vT = selT.value;
            selR.innerHTML = '<option value="all">Todas</option>'+reg.map(x=>`<option>${x}</option>`).join('');
            selT.innerHTML = '<option value="all">Todos</option>'+typ.map(x=>`<option>${x}</option>`).join('');
            if([...selR.options].some(o=>o.value===vR)) selR.value=vR;
            if([...selT.options].some(o=>o.value===vT)) selT.value=vT;
        }

        function setupListeners() {
            document.getElementById('csvInput').addEventListener('change', e => {
                const f = e.target.files[0]; if(!f)return;
                const r = new FileReader();
                r.onload = ev => {
                    const txt = ev.target.result;
                    const parsed = parseCSVLogic(txt);
                    if(parsed.length>0 && confirm(`Importar ${parsed.length} itens?`)) { appData=parsed; saveToStorage(); alert("Importado!"); }
                };
                r.readAsText(f);
            });
            ['filter-region','filter-type','filter-text'].forEach(id => document.getElementById(id).addEventListener(id==='filter-text'?'input':'change', filterAndRender));
        }

        function parseCSVLogic(text) {
            if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
            const lines = text.split(/\r\n|\n|\r/).filter(l => l.trim());
            if(lines.length < 2) return [];
            // Auto-detect delimiter
            const delim = (lines[0].match(/;/g)||[]).length > (lines[0].match(/,/g)||[]).length ? ';' : ',';
            
            return lines.slice(1).map(line => {
                // Split logic respecting quotes
                const row = line.split(delim===';' ? /;(?=(?:(?:[^"]*"){2})*[^"]*$)/ : /,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                if(row.length<5) return null;
                const clean = s => s ? s.replace(/^"|"$/g,'').trim() : '';
                const pNum = s => { if(!s)return 0; let v=s.toString().replace(/[^\d.,-]/g,''); if(v.includes(',')&&v.includes('.')) v=v.replace(/\./g,'').replace(',','.'); else v=v.replace(',','.'); return parseFloat(v)||0; };
                
                // Map columns
                // Expected: ID, Nome, Cidade, Regiao, Tipo, Endereco, Preco, Nota, Link, Tel, Obs
                return { 
                    id:clean(row[0]), name:clean(row[1]), city:clean(row[2]), region:clean(row[3]), 
                    type:clean(row[4]), address:clean(row[5]), price:pNum(row[6]), rating:pNum(row[7]), 
                    link:clean(row[8]), phone:clean(row[9]), info:clean(row[10])
                };
            }).filter(x=>x);
        }

        function downloadCSV() {
            let csv = "ID_Empreendimento;Nome_Local;Cidade;Corede_Regiao;Tipo_Estabelecimento;Endereco_Completo;Preco_Medio;Nota_Avaliacao;Link_Acesso;Contato_Telefonico;Campo_Extra_Observacoes\n";
            appData.forEach(d => {
                const c = s => s ? String(s).replace(/;/g,',').replace(/\n/g,'') : '';
                csv += `${c(d.id)};${c(d.name)};${c(d.city)};${c(d.region)};${c(d.type)};${c(d.address)};${d.price.toLocaleString('pt-BR',{minimumFractionDigits:2})};${d.rating.toLocaleString('pt-BR')};${c(d.link)};${c(d.phone)};${c(d.info)}\n`;
            });
            const url = URL.createObjectURL(new Blob(["\ufeff"+csv], {type:'text/csv;charset=utf-8'}));
            const a = document.createElement('a'); a.href=url; a.download=`banco_dados.csv`; document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        function switchTab(t) {
            ['overview','dashboard','database'].forEach(id => {
                document.getElementById('nav-'+id).className = id===t ? 'tab-active px-1 pt-1 text-sm font-medium transition-colors' : 'tab-inactive px-1 pt-1 text-sm font-medium transition-colors';
                document.getElementById('view-'+id).classList.toggle('hidden', id!==t);
            });
            if(t==='dashboard') setTimeout(renderCharts, 50);
        }

        function updateStats() {
            const vP = appData.filter(d=>d.price>0), vR = appData.filter(d=>d.rating>0);
            document.getElementById('stat-total').textContent = appData.length;
            document.getElementById('stat-price').textContent = "R$ " + (vP.length ? (vP.reduce((a,b)=>a+b.price,0)/vP.length).toLocaleString('pt-BR',{maximumFractionDigits:0}) : "0");
            document.getElementById('stat-rating').textContent = vR.length ? (vR.reduce((a,b)=>a+b.rating,0)/vR.length).toLocaleString('pt-BR',{maximumFractionDigits:1}) : "0.0";
            document.getElementById('stat-cities').textContent = new Set(appData.map(d=>d.city)).size;
        }

        function renderCharts() {
            if(!document.getElementById('typeChart')) return;
            const t={}, rQ={}, rR={}, p=[0,0,0,0];
            appData.forEach(i => {
                t[i.type] = (t[i.type]||0)+1;
                if(i.region) rQ[i.region] = (rQ[i.region]||0)+1;
                if(i.region && i.rating>0) { if(!rR[i.region]) rR[i.region]={sum:0,cnt:0}; rR[i.region].sum+=i.rating; rR[i.region].cnt++; }
                if(i.price>0) { if(i.price<150)p[0]++; else if(i.price<250)p[1]++; else if(i.price<400)p[2]++; else p[3]++; }
            });
            const c=['#475C2A','#637D3D','#2E3D1B','#8FA866','#B5C799'];
            const com={responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}};
            const make=(id,typ,lbl,dat,bg,op)=> { if(charts[id])charts[id].destroy(); charts[id]=new Chart(document.getElementById(id),{type:typ,data:{labels:lbl,datasets:[{data:dat,backgroundColor:bg,borderRadius:4,borderWidth:0}]},options:op}); };
            
            make('typeChart','doughnut',Object.keys(t),Object.values(t),c,{...com,plugins:{legend:{position:'bottom'}}});
            make('regionCountChart','bar',Object.keys(rQ),Object.values(rQ),'#78716c',com);
            make('regionChart','bar',Object.keys(rR),Object.keys(rR).map(k=>(rR[k].sum/rR[k].cnt).toFixed(1)),'#475C2A',{...com,scales:{y:{min:3,max:5}}});
            make('priceChart','bar',['<150','150-250','250-400','>400'],p,'#a8a29e',com);
        }
    </script>
</body>
</html>

